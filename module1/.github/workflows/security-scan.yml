name: ML Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit semgrep pylint safety pip-audit

      - name: Create reports directory
        run: mkdir -p security-reports

      # ==================== BANDIT SCAN ====================
      - name: Run Bandit (Python Security Linter)
        run: |
          echo "=== Running Bandit Security Scan ==="
          bandit -r . -f json -o security-reports/bandit.json --exclude ./venv,./.github || true
          bandit -r . -f txt --exclude ./venv,./.github > security-reports/bandit.txt || true
          echo "Bandit scan complete"
        continue-on-error: true

      - name: Bandit Summary
        run: |
          echo "### Bandit Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat security-reports/bandit.txt | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ==================== SEMGREP SCAN ====================
      - name: Run Semgrep (SAST)
        run: |
          echo "=== Running Semgrep SAST Scan ==="
          semgrep --config=auto . --json -o security-reports/semgrep.json --exclude venv --exclude .github || true
          semgrep --config=auto . --exclude venv --exclude .github > security-reports/semgrep.txt 2>&1 || true
          echo "Semgrep scan complete"
        continue-on-error: true

      - name: Semgrep Summary
        run: |
          echo "### Semgrep Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "Findings:|findings" security-reports/semgrep.txt | head -5 >> $GITHUB_STEP_SUMMARY || echo "See full report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ==================== PYLINT SCAN ====================
      - name: Run PyLint (Code Quality)
        run: |
          echo "=== Running PyLint Analysis ==="
          pylint *.py --output-format=json > security-reports/pylint.json 2>/dev/null || true
          pylint *.py > security-reports/pylint.txt 2>&1 || true
          echo "PyLint scan complete"
        continue-on-error: true

      - name: PyLint Summary
        run: |
          echo "### PyLint Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat security-reports/pylint.txt | tail -5 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ==================== SAFETY SCAN ====================
      - name: Run Safety (Dependency Vulnerabilities)
        run: |
          echo "=== Running Safety Dependency Scan ==="
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt --output json > security-reports/safety.json 2>/dev/null || true
            safety check -r requirements.txt > security-reports/safety.txt 2>&1 || true
          else
            echo "No requirements.txt found" > security-reports/safety.txt
          fi
          echo "Safety scan complete"
        continue-on-error: true

      - name: Safety Summary
        run: |
          echo "### Safety (Dependency) Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "vulnerabilities|Vulnerability" security-reports/safety.txt | head -10 >> $GITHUB_STEP_SUMMARY || echo "See full report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ==================== PIP-AUDIT SCAN ====================
      - name: Run pip-audit (Additional Dependency Check)
        run: |
          echo "=== Running pip-audit ==="
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt --format json > security-reports/pip-audit.json 2>/dev/null || true
            pip-audit -r requirements.txt > security-reports/pip-audit.txt 2>&1 || true
          fi
          echo "pip-audit complete"
        continue-on-error: true

      # ==================== AGGREGATE REPORT ====================
      - name: Generate Aggregate Report
        run: |
          echo "# Security Scan Aggregate Report" > security-reports/AGGREGATE_REPORT.md
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-reports/AGGREGATE_REPORT.md
          echo "**Repository:** ${{ github.repository }}" >> security-reports/AGGREGATE_REPORT.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-reports/AGGREGATE_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> security-reports/AGGREGATE_REPORT.md
          echo "" >> security-reports/AGGREGATE_REPORT.md

          echo "## Summary" >> security-reports/AGGREGATE_REPORT.md
          echo "" >> security-reports/AGGREGATE_REPORT.md

          # Count Bandit issues
          if [ -f security-reports/bandit.json ]; then
            BANDIT_COUNT=$(python3 -c "import json; data=json.load(open('security-reports/bandit.json')); print(len(data.get('results', [])))" 2>/dev/null || echo "0")
            echo "- **Bandit:** $BANDIT_COUNT issues found" >> security-reports/AGGREGATE_REPORT.md
          fi

          # Count Semgrep issues
          if [ -f security-reports/semgrep.json ]; then
            SEMGREP_COUNT=$(python3 -c "import json; data=json.load(open('security-reports/semgrep.json')); print(len(data.get('results', [])))" 2>/dev/null || echo "0")
            echo "- **Semgrep:** $SEMGREP_COUNT issues found" >> security-reports/AGGREGATE_REPORT.md
          fi

          echo "" >> security-reports/AGGREGATE_REPORT.md
          echo "See individual reports for details." >> security-reports/AGGREGATE_REPORT.md

      # ==================== UPLOAD ARTIFACTS ====================
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/
          retention-days: 30

      # ==================== FAIL ON CRITICAL ====================
      - name: Check for Critical Vulnerabilities
        run: |
          echo "Checking for critical/high severity findings..."

          # Check Bandit for high severity
          if [ -f security-reports/bandit.json ]; then
            HIGH_COUNT=$(python3 -c "
          import json
          data = json.load(open('security-reports/bandit.json'))
          high = len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH'])
          print(high)
          " 2>/dev/null || echo "0")
            echo "Bandit HIGH severity findings: $HIGH_COUNT"

            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "::warning::Found $HIGH_COUNT high severity issues in Bandit scan"
            fi
          fi

          # Note: In production, you might want to fail the build:
          # if [ "$HIGH_COUNT" -gt 0 ]; then
          #   echo "::error::Critical vulnerabilities found. Failing build."
          #   exit 1
          # fi

          echo "Security scan completed. Review artifacts for full details."

  # ==================== SECRETS DETECTION ====================
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ""
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true

  # ==================== DEPENDENCY REVIEW ====================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
        continue-on-error: true
